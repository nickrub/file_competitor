<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaming Analytics Dashboard - Performance Optimized (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: #f3f4f6;
        }
        .sort-arrow {
            display: inline-block;
            margin-left: 5px;
            transition: transform 0.2s;
        }

        /* üöÄ PROGRESS BAR STYLES */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            text-align: center;
            display: none;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* üöÄ PERFORMANCE INDICATORS */
        .performance-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }

        .loading-badge {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
            animation: pulse 1s infinite;
        }

        .nav-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .nav-tab:last-child {
            border-right: none;
        }
        
        .nav-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 -3px 0 0 #fbbf24;
        }
        
        .nav-tab-icon {
            display: block;
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .nav-tab-text {
            font-size: 14px;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            padding: 24px;
            min-height: 400px;
        }
        
        .tab-content.active {
            display: block;
        }

        .section-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .negative-value {
            color: #dc2626;
            font-weight: bold;
        }

        .channel-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .channel-fisico {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .channel-online {
            background: #dcfce7;
            color: #166534;
        }

        .tipo-gioco-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            min-width: 50px;
        }

        .comparto-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            background: #e0f7fa;
            color: #00695c;
            border: 1px solid #b2dfdb;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen">
    <!-- üöÄ PROGRESS BAR -->
    <div id="loadingProgress" class="progress-container">
        <div id="progressText" class="progress-text">Caricamento in corso...</div>
        <div class="progress-bar-bg">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div class="text-xs mt-2">üí° I file grandi vengono elaborati in modo ottimizzato per le migliori performance</div>
    </div>

    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="glass-effect rounded-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-white mb-2">
                Gaming Analytics Dashboard 
                <span class="performance-badge">üöÄ OTTIMIZZATO v3.0</span>
                <span class="performance-badge">üõ†Ô∏è FIXED</span>
            </h1>
            <p class="text-gray-300">Analisi dati statistiche GAD - Quote spesa per giochi con performance ottimizzate per grandi dataset</p>
            <div id="dataStatus" class="mt-2 text-sm text-blue-200"></div>
        </div>

        <!-- Sistema di Navigazione -->
        <div class="nav-container mb-6">
            <!-- Tab Navigation -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('gestione')">
                    <span class="nav-tab-icon">‚öôÔ∏è</span>
                    <span class="nav-tab-text">Gestione</span>
                </div>
                <div class="nav-tab" onclick="switchTab('grafici')">
                    <span class="nav-tab-icon">üìä</span>
                    <span class="nav-tab-text">Grafici</span>
                </div>
                <div class="nav-tab" onclick="switchTab('tabelle')">
                    <span class="nav-tab-icon">üìã</span>
                    <span class="nav-tab-text">Tabelle</span>
                </div>
            </div>

            <!-- TAB 1: GESTIONE -->
            <div id="tab-gestione" class="tab-content active">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">‚öôÔ∏è Gestione Sistema</h2>
                
                <!-- Upload Section -->
                <div class="section-container">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        üìÅ Carica File Excel 
                        <span class="performance-badge">‚ú® OTTIMIZZATO</span>
                    </h3>
                    <div class="flex items-center space-x-4 mb-4 flex-wrap gap-2">
                        <input type="file" id="fileInput" accept=".xlsx,.xls" multiple 
                               class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 
                                      file:rounded-full file:border-0 file:text-sm file:font-semibold 
                                      file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <button onclick="processFiles()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg 
                                       transition-colors duration-200 whitespace-nowrap">
                            üöÄ Elabora File
                        </button>
                        <button onclick="clearData()" 
                                class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg 
                                       transition-colors duration-200 whitespace-nowrap">
                            üóëÔ∏è Cancella Dati
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mb-4">
                        üí° <strong>Formati Supportati:</strong><br>
                        ‚Ä¢ <strong>Formato Standard GAD</strong>: Statistiche normali<br>
                        ‚Ä¢ <strong>Formato Nuovo</strong>: Con "Periodo da..." nella riga 2<br>
                        ‚Ä¢ <strong>Formato Ippico</strong>: Scommesse Ippica<br>
                        ‚Ä¢ <strong>üÜï Formato Storico</strong>: DB-MARKET SHARE con 99k+ record
                    </div>
                    <div id="uploadStatus" class="text-sm text-gray-600"></div>
                </div>

                <!-- Info caricati -->
                <div id="loadedDataInfo" class="section-container" style="display: none;">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Dati Caricati</h3>
                    <div id="dataInfo" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Populated via JS -->
                    </div>
                </div>
            </div>

            <!-- TAB 2: GRAFICI -->
            <div id="tab-grafici" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">üìä Grafici e Statistiche</h2>
                
                <div id="analyticsSection" style="display: none;">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Chart Container -->
                        <div class="lg:col-span-2">
                            <div class="glass-effect rounded-lg p-6 h-full">
                                <h3 class="text-lg font-semibold text-white mb-4">üìà Grafici Interattivi</h3>
                                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <select id="chartType" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                        <option value="bar">üìä Grafico a Barre</option>
                                        <option value="line">üìà Grafico a Linee</option>
                                        <option value="pie">ü•ß Grafico a Torta</option>
                                        <option value="doughnut">üç© Grafico a Ciambella</option>
                                    </select>
                                    <select id="chartGroupBy" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                        <option value="concessionarioNome">Raggruppa per Concessionario</option>
                                        <option value="gameNameComplete">Raggruppa per Gioco</option>
                                        <option value="comparto">Raggruppa per Comparto</option>
                                        <option value="canale">Raggruppa per Canale</option>
                                        <option value="quarterYear">Raggruppa per Trimestre</option>
                                        <option value="monthYear">Raggruppa per Mese</option>
                                    </select>
                                </div>
                                <div class="relative" style="height: 400px;">
                                    <canvas id="mainChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Container -->
                        <div>
                            <div class="glass-effect rounded-lg p-6 h-full">
                                <h3 class="text-lg font-semibold text-white mb-4">üìã Statistiche</h3>
                                <div id="summaryStats" class="space-y-4">
                                    <!-- Stats popolate via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noChartsMessage" class="text-center text-gray-600 mt-8">
                    <div class="text-6xl mb-4">üìà</div>
                    <h3 class="text-xl font-semibold mb-2">Nessun dato disponibile</h3>
                    <p>Carica dei file Excel dalla sezione "Gestione" per visualizzare i grafici.</p>
                </div>
            </div>

            <!-- TAB 3: TABELLE -->
            <div id="tab-tabelle" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">üìã Tabelle Dati</h2>
                
                <div id="tableSection" style="display: none;">
                    <div class="glass-effect rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">üìä Tabella Dati</h3>
                            <button onclick="downloadCSV()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                üìä Scarica CSV
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table id="dataTable" class="min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden">
                                <thead id="tableHead" class="bg-gray-50">
                                    <!-- Headers popolati via JS -->
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Data popolati via JS -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="paginationControls" class="mt-4 flex justify-between items-center">
                            <span id="recordCount" class="text-white text-sm"></span>
                            <div class="space-x-2">
                                <button onclick="previousPage()" id="prevBtn" class="bg-gray-600 text-white px-3 py-1 rounded">‚Üê Precedente</button>
                                <span id="pageInfo" class="text-white text-sm"></span>
                                <button onclick="nextPage()" id="nextBtn" class="bg-gray-600 text-white px-3 py-1 rounded">Successiva ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noTableMessage" class="text-center text-gray-600 mt-8">
                    <div class="text-6xl mb-4">üìã</div>
                    <h3 class="text-xl font-semibold mb-2">Nessun dato disponibile</h3>
                    <p>Carica dei file Excel dalla sezione "Gestione" per visualizzare la tabella.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        let allData = [];
        let currentChart = null;
        let currentPage = 0;
        const PAGE_SIZE = 50;

        // Mappa per conversione mesi
        const monthNames = {
            '01': 'Gennaio', '02': 'Febbraio', '03': 'Marzo', '04': 'Aprile',
            '05': 'Maggio', '06': 'Giugno', '07': 'Luglio', '08': 'Agosto',
            '09': 'Settembre', '10': 'Ottobre', '11': 'Novembre', '12': 'Dicembre'
        };

        // Mappa per trimestri
        const quarterNames = {
            'Q1': 'üå± Q1 (Gen-Mar)',
            'Q2': 'üåû Q2 (Apr-Giu)', 
            'Q3': 'üçÇ Q3 (Lug-Set)',
            'Q4': '‚ùÑÔ∏è Q4 (Ott-Dic)'
        };

        // Mappa per canali
        const channelNames = {
            'fisico': 'üìç Fisico',
            'online': 'üíª Online',
            'FISICO': 'üìç Fisico',
            'ONLINE': 'üíª Online'
        };

        // Progress bar
        function showProgress(message, percent = 0) {
            const progressDiv = document.getElementById('loadingProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progressDiv && progressBar && progressText) {
                progressDiv.style.display = 'block';
                progressBar.style.width = `${percent}%`;
                progressText.textContent = message;
                
                if (percent >= 100) {
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 1000);
                }
            }
        }

        // Status messages
        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `mt-4 text-sm ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600'}`;
            }
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Helper functions
        function parseItalianNumber(value) {
            if (value === null || value === undefined || value === '') return 0;
            if (typeof value === 'number') return value;
            
            let numStr = value.toString().trim().replace(/[^\d.,+-]/g, '');
            if (!numStr) return 0;
            
            if (numStr.includes(',')) {
                const cleaned = numStr.replace(/\./g, '').replace(',', '.');
                const parsed = parseFloat(cleaned);
                return isNaN(parsed) ? 0 : parsed;
            }
            
            const parsed = parseFloat(numStr);
            return isNaN(parsed) ? 0 : parsed;
        }

        function getQuarter(month) {
            const monthNum = parseInt(month);
            if (monthNum >= 1 && monthNum <= 3) return 'Q1';
            if (monthNum >= 4 && monthNum <= 6) return 'Q2';
            if (monthNum >= 7 && monthNum <= 9) return 'Q3';
            return 'Q4';
        }

        function formatItalianNumber(value) {
            if (typeof value === 'number') {
                return value.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            return value;
        }

        // Riconoscimento formati
        function isHistoricalFormat(jsonData) {
            if (!jsonData || jsonData.length < 2) return false;
            
            const headers = jsonData[0];
            if (!Array.isArray(headers)) return false;
            
            // Controlla se ha le colonne tipiche del formato storico
            const expectedColumns = ['ANNO', 'MESE', 'N.CONC.', 'CONCESSIONARIO', 'GIOCO'];
            return expectedColumns.some(col => 
                headers.some(header => header && header.toString().toUpperCase().includes(col))
            );
        }

        function isNewFormat(jsonData) {
            if (!jsonData || jsonData.length < 3) return false;
            
            // Controlla se la riga 2 contiene "Periodo da"
            const row1 = jsonData[1];
            return row1 && row1[0] && row1[0].toString().includes('Periodo da');
        }

        function isHippoFormat(jsonData) {
            if (!jsonData || jsonData.length < 2) return false;
            
            // Controlla se il titolo contiene "Scommesse Ippica"
            const titleRow = jsonData[0];
            return titleRow && titleRow[0] && titleRow[0].toString().includes('Scommesse Ippica');
        }

        // Parsing dei formati
        async function parseHistoricalFormat(jsonData, fileName) {
            console.log(`Parsing formato storico: ${fileName}`);
            showProgress('Elaborazione formato storico...', 30);
            
            if (jsonData.length < 2) {
                throw new Error(`File ${fileName}: formato storico non valido`);
            }

            const headers = jsonData[0];
            const dataRows = jsonData.slice(1).filter(row => 
                row && row[0] && row[1] && row[2] && row[3]
            );
            
            console.log(`Formato storico: elaborando ${dataRows.length} righe`);
            
            const results = [];
            
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                
                if (i % 5000 === 0) {
                    showProgress(`Elaborazione riga ${i}/${dataRows.length}...`, 30 + (i / dataRows.length) * 40);
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                const anno = row[0];
                
                // Gestione data
                let month = '01';
                try {
                    const dateValue = row[1];
                    if (dateValue instanceof Date) {
                        month = (dateValue.getMonth() + 1).toString().padStart(2, '0');
                    } else if (typeof dateValue === 'string') {
                        const dateObj = new Date(dateValue);
                        month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    } else if (typeof dateValue === 'number') {
                        const dateObj = new Date((dateValue - 25569) * 86400 * 1000);
                        month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    }
                } catch (error) {
                    month = '01';
                }

                const year = anno.toString();
                const quarter = getQuarter(month);
                const quarterYear = `${quarter}/${year}`;
                
                const codiceConcessione = (row[2] || '').toString().trim();
                const ragioneSociale = (row[3] || '').toString().trim();
                const concessionario = (row[4] || '').toString().trim();
                const canale = (row[5] || 'fisico').toString().toLowerCase().trim();
                const gruppo = (row[6] || '').toString().trim();
                const comparto = (row[7] || 'Non classificato').toString().trim();
                const gioco = (row[8] || 'Gioco Sconosciuto').toString().trim();
                
                const ggt = Number(row[9]) || 0;
                const payout = Number(row[10]) || 0;
                const spesa = Number(row[11]) || 0;
                
                const importoRaccolta = formatItalianNumber(ggt);
                const importoSpesa = formatItalianNumber(spesa);
                
                let percentualeRaccolta = '0%';
                let percentualeSpesa = '0%';
                
                if (ggt > 0) {
                    const percSpesa = (spesa / ggt) * 100;
                    percentualeSpesa = percSpesa.toFixed(2) + '%';
                    
                    const percPayout = (payout / ggt) * 100;
                    percentualeRaccolta = percPayout.toFixed(2) + '%';
                }

                results.push({
                    fileName: fileName,
                    gameName: gioco,
                    gameNameComplete: gioco,
                    month: month,
                    year: year,
                    monthYear: `${month}/${year}`,
                    quarter: quarter,
                    quarterYear: quarterYear,
                    codiceConcessione: codiceConcessione,
                    ragioneSociale: ragioneSociale,
                    concessionarioNome: concessionario,
                    importoRaccolta: importoRaccolta,
                    percentualeRaccolta: percentualeRaccolta,
                    importoSpesa: importoSpesa,
                    percentualeSpesa: percentualeSpesa,
                    monthName: monthNames[month] || month,
                    quarterName: quarterNames[quarter] || quarter,
                    isNegativeSpesa: spesa < 0,
                    canale: canale,
                    channelName: channelNames[canale] || canale,
                    concessionarioPropriet√†: 'Non specificato',
                    comparto: comparto,
                    gruppo: gruppo,
                    fileFormat: 'historicalFormat'
                });
            }
            
            return results;
        }

        async function parseNewFormat(jsonData, fileName) {
            console.log(`Parsing nuovo formato: ${fileName}`);
            showProgress('Elaborazione nuovo formato...', 30);
            
            if (jsonData.length < 5) {
                throw new Error(`File ${fileName}: nuovo formato non valido`);
            }

            // Trova gli headers (di solito riga 4)
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(jsonData.length, 10); i++) {
                const row = jsonData[i];
                if (row && row[0] && row[0].toString().includes('CODICE CONCESSIONE')) {
                    headerRowIndex = i;
                    break;
                }
            }
            
            if (headerRowIndex === -1) {
                throw new Error(`File ${fileName}: headers non trovati nel nuovo formato`);
            }

            const headers = jsonData[headerRowIndex];
            const dataRows = jsonData.slice(headerRowIndex + 1).filter(row => 
                row && row[0] && row[1]
            );
            
            console.log(`Nuovo formato: elaborando ${dataRows.length} righe`);
            
            // Estrai periodo dal titolo
            const titleRow = jsonData[0];
            let month = '01', year = '2025';
            
            if (titleRow && titleRow[0]) {
                const title = titleRow[0].toString();
                const monthMatch = title.match(/(\w+) (\d{4})/);
                if (monthMatch) {
                    const monthName = monthMatch[1].toLowerCase();
                    year = monthMatch[2];
                    
                    const monthMapping = {
                        'gennaio': '01', 'febbraio': '02', 'marzo': '03', 'aprile': '04',
                        'maggio': '05', 'giugno': '06', 'luglio': '07', 'agosto': '08',
                        'settembre': '09', 'ottobre': '10', 'novembre': '11', 'dicembre': '12'
                    };
                    month = monthMapping[monthName] || '01';
                }
            }

            const quarter = getQuarter(month);
            const quarterYear = `${quarter}/${year}`;
            
            const results = [];
            
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                
                if (i % 1000 === 0) {
                    showProgress(`Elaborazione riga ${i}/${dataRows.length}...`, 30 + (i / dataRows.length) * 40);
                    await new Promise(resolve => setTimeout(resolve, 5));
                }

                const codiceConcessione = (row[0] || '').toString().trim();
                const ragioneSociale = (row[1] || '').toString().trim();
                const importoRaccolta = (row[2] || '0').toString().trim();
                const percentualeRaccolta = (row[3] || '0%').toString().trim();
                const importoSpesa = (row[4] || '0').toString().trim();
                const percentualeSpesa = (row[5] || '0%').toString().trim();

                const spesaNum = parseItalianNumber(importoSpesa);

                results.push({
                    fileName: fileName,
                    gameName: 'Giochi di Abilit√† in Torneo',
                    gameNameComplete: 'Giochi di Abilit√† in Torneo',
                    month: month,
                    year: year,
                    monthYear: `${month}/${year}`,
                    quarter: quarter,
                    quarterYear: quarterYear,
                    codiceConcessione: codiceConcessione,
                    ragioneSociale: ragioneSociale,
                    concessionarioNome: ragioneSociale,
                    importoRaccolta: importoRaccolta,
                    percentualeRaccolta: percentualeRaccolta,
                    importoSpesa: importoSpesa,
                    percentualeSpesa: percentualeSpesa,
                    monthName: monthNames[month] || month,
                    quarterName: quarterNames[quarter] || quarter,
                    isNegativeSpesa: spesaNum < 0,
                    canale: 'online',
                    channelName: 'üíª Online',
                    concessionarioPropriet√†: 'Non specificato',
                    comparto: 'Giochi di Abilit√†',
                    gruppo: 'Torneo',
                    fileFormat: 'newFormat'
                });
            }
            
            return results;
        }

        // Main file processing
        async function processFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                showStatus('Seleziona almeno un file Excel', 'error');
                return;
            }

            showProgress('Avvio elaborazione...', 0);
            
            try {
                let newData = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    showProgress(`Lettura file ${i + 1}/${files.length}: ${file.name}`, (i / files.length) * 20);
                    
                    const data = await readExcelFile(file);
                    newData.push(...data);
                }
                
                if (newData.length > 0) {
                    showProgress('Finalizzazione...', 90);
                    
                    // Rimuovi duplicati
                    const existingKeys = new Set(allData.map(item => 
                        `${item.fileName}-${item.codiceConcessione}-${item.monthYear}`
                    ));
                    
                    const uniqueNewData = newData.filter(item => 
                        !existingKeys.has(`${item.fileName}-${item.codiceConcessione}-${item.monthYear}`)
                    );
                    
                    allData.push(...uniqueNewData);
                    
                    showProgress('Completato!', 100);
                    showStatus(`Elaborati ${uniqueNewData.length} nuovi record da ${files.length} file`, 'success');
                    
                    updateDataInfo();
                    updateDisplays();
                } else {
                    showProgress('Errore', 100);
                    showStatus('Nessun dato trovato nei file', 'error');
                }
            } catch (error) {
                showProgress('Errore', 100);
                showStatus(`Errore nell'elaborazione: ${error.message}`, 'error');
                console.error('Errore dettagliato:', error);
            }
        }

        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        console.log(`Lettura file: ${file.name}`);
                        
                        const workbook = XLSX.read(e.target.result, { 
                            type: 'binary', 
                            cellDates: true
                        });
                        
                        // Strategia di selezione del foglio
                        let sheetName = workbook.SheetNames[0];
                        let worksheet = workbook.Sheets[sheetName];
                        
                        // Cerca foglio storico
                        if (workbook.SheetNames.includes('DB-MARKET SHARE-2022')) {
                            console.log('Rilevato file DB CPT - usando foglio DB-MARKET SHARE-2022');
                            sheetName = 'DB-MARKET SHARE-2022';
                            worksheet = workbook.Sheets[sheetName];
                        }
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        console.log(`File ${file.name}: ${jsonData.length} righe nel foglio ${sheetName}`);
                        
                        let parsedData;
                        
                        if (isHistoricalFormat(jsonData)) {
                            console.log(`Formato STORICO riconosciuto per: ${file.name}`);
                            parsedData = await parseHistoricalFormat(jsonData, file.name);
                        }
                        else if (isNewFormat(jsonData)) {
                            console.log(`Formato NUOVO riconosciuto per: ${file.name}`);
                            parsedData = await parseNewFormat(jsonData, file.name);
                        }
                        else {
                            console.log(`Formato STANDARD riconosciuto per: ${file.name}`);
                            parsedData = await parseNewFormat(jsonData, file.name); // Fallback
                        }
                        
                        console.log(`File ${file.name}: ${parsedData.length} record elaborati`);
                        resolve(parsedData);
                    } catch (error) {
                        console.error(`Errore nel file ${file.name}:`, error);
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error(`Errore nella lettura del file ${file.name}`));
                };
                
                reader.readAsBinaryString(file);
            });
        }

        // UI Updates
        function updateDataInfo() {
            const infoDiv = document.getElementById('loadedDataInfo');
            const dataInfoDiv = document.getElementById('dataInfo');
            
            if (allData.length > 0) {
                infoDiv.style.display = 'block';
                
                const totalRecords = allData.length;
                const uniqueGames = new Set(allData.map(item => item.gameNameComplete)).size;
                const uniqueConcessionari = new Set(allData.map(item => item.concessionarioNome)).size;
                const dateRange = getDateRange();
                
                dataInfoDiv.innerHTML = `
                    <div class="bg-blue-500 bg-opacity-20 rounded-lg p-4">
                        <h4 class="text-blue-700 font-medium">Totale Record</h4>
                        <p class="text-2xl font-bold text-blue-900">${totalRecords.toLocaleString()}</p>
                    </div>
                    <div class="bg-green-500 bg-opacity-20 rounded-lg p-4">
                        <h4 class="text-green-700 font-medium">Giochi Unici</h4>
                        <p class="text-2xl font-bold text-green-900">${uniqueGames}</p>
                    </div>
                    <div class="bg-purple-500 bg-opacity-20 rounded-lg p-4">
                        <h4 class="text-purple-700 font-medium">Concessionari</h4>
                        <p class="text-2xl font-bold text-purple-900">${uniqueConcessionari}</p>
                    </div>
                `;
            } else {
                infoDiv.style.display = 'none';
            }
        }

        function getDateRange() {
            if (allData.length === 0) return 'N/A';
            
            const years = allData.map(item => parseInt(item.year)).filter(y => !isNaN(y));
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);
            
            return minYear === maxYear ? minYear.toString() : `${minYear}-${maxYear}`;
        }

        function updateDisplays() {
            updateChart();
            updateTable();
            updateSummaryStats();
            
            // Mostra sezioni
            document.getElementById('analyticsSection').style.display = 'block';
            document.getElementById('tableSection').style.display = 'block';
        }

        function updateChart() {
            if (allData.length === 0) return;
            
            const chartType = document.getElementById('chartType').value;
            const groupBy = document.getElementById('chartGroupBy').value;
            
            if (currentChart) {
                currentChart.destroy();
            }

            const chartData = prepareChartData(groupBy);
            const ctx = document.getElementById('mainChart').getContext('2d');

            const config = {
                type: chartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Importo Spesa per ${getGroupByTitle(groupBy)} (Top 20)`
                        }
                    },
                    scales: chartType !== 'pie' && chartType !== 'doughnut' ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            };

            currentChart = new Chart(ctx, config);
        }

        function prepareChartData(groupBy) {
            const grouped = _.groupBy(allData, groupBy);
            const labels = [];
            const data = [];
            
            Object.keys(grouped).forEach(groupKey => {
                const sum = grouped[groupKey].reduce((acc, item) => {
                    const value = parseItalianNumber(item.importoSpesa);
                    return acc + value;
                }, 0);
                
                labels.push(groupKey.length > 20 ? groupKey.substring(0, 20) + '...' : groupKey);
                data.push(sum);
            });

            // Ordina e prendi top 20
            const combined = labels.map((label, index) => ({ label, value: data[index] }));
            combined.sort((a, b) => b.value - a.value);
            const topItems = combined.slice(0, 20);

            return {
                labels: topItems.map(item => item.label),
                datasets: [{
                    label: 'Importo Spesa',
                    data: topItems.map(item => item.value),
                    backgroundColor: generateColors(topItems.length),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            };
        }

        function updateTable() {
            if (allData.length === 0) return;
            
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            // Headers
            const headers = ['Gioco', 'Comparto', 'Anno', 'Mese', 'Canale', 'Codice', 'Concessionario', 'Ragione Sociale', 'Importo Raccolta', 'Importo Spesa'];
            tableHead.innerHTML = `
                <tr>
                    ${headers.map(header => `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`).join('')}
                </tr>
            `;
            
            // Paginazione
            const startIndex = currentPage * PAGE_SIZE;
            const endIndex = Math.min(startIndex + PAGE_SIZE, allData.length);
            const displayedData = allData.slice(startIndex, endIndex);
            
            tableBody.innerHTML = displayedData.map(row => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.gameNameComplete || row.gameName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.comparto || '-'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.year}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.monthName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">
                        <span class="channel-badge channel-${row.canale}">${row.channelName}</span>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.codiceConcessione}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.concessionarioNome}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.ragioneSociale}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${row.importoRaccolta}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 ${row.isNegativeSpesa ? 'negative-value' : ''}">${row.importoSpesa}</td>
                </tr>
            `).join('');
            
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(allData.length / PAGE_SIZE);
            const recordCount = document.getElementById('recordCount');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            recordCount.textContent = `Mostra ${currentPage * PAGE_SIZE + 1}-${Math.min((currentPage + 1) * PAGE_SIZE, allData.length)} di ${allData.length} record`;
            pageInfo.textContent = `Pagina ${currentPage + 1} di ${totalPages}`;
            
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage >= totalPages - 1;
        }

        function updateSummaryStats() {
            if (allData.length === 0) return;
            
            const totalRecords = allData.length;
            const uniqueConcessionari = new Set(allData.map(item => item.concessionarioNome)).size;
            
            const totalRaccolta = allData.reduce((sum, item) => {
                const value = parseItalianNumber(item.importoRaccolta);
                return sum + value;
            }, 0);
            
            const totalSpesa = allData.reduce((sum, item) => {
                const value = parseItalianNumber(item.importoSpesa);
                return sum + value;
            }, 0);
            
            const summaryDiv = document.getElementById('summaryStats');
            summaryDiv.innerHTML = `
                <div class="bg-blue-500 bg-opacity-20 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-blue-200">Totale Record</h4>
                    <p class="text-2xl font-bold text-white">${totalRecords.toLocaleString()}</p>
                </div>
                <div class="bg-green-500 bg-opacity-20 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-green-200">Totale Raccolta</h4>
                    <p class="text-2xl font-bold text-white">${totalRaccolta.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</p>
                </div>
                <div class="bg-purple-500 bg-opacity-20 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-purple-200">Totale Spesa</h4>
                    <p class="text-2xl font-bold text-white">${totalSpesa.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</p>
                </div>
                <div class="bg-yellow-500 bg-opacity-20 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-yellow-200">Concessionari</h4>
                    <p class="text-2xl font-bold text-white">${uniqueConcessionari}</p>
                </div>
            `;
        }

        function generateColors(count) {
            const colors = [
                'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)', 'rgba(83, 102, 255, 0.8)', 'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)', 'rgba(255, 159, 243, 0.8)', 'rgba(159, 255, 64, 0.8)'
            ];
            return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
        }

        function getGroupByTitle(groupBy) {
            const titles = {
                'concessionarioNome': 'Concessionario',
                'ragioneSociale': 'Ragione Sociale',
                'canale': 'Canale',
                'quarterYear': 'Trimestre',
                'monthYear': 'Mese',
                'gameNameComplete': 'Gioco',
                'comparto': 'Comparto',
                'gruppo': 'Gruppo'
            };
            return titles[groupBy] || groupBy;
        }

        // Navigation
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.closest('.nav-tab').classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            updateSectionVisibility(tabName);
        }
        
        function updateSectionVisibility(activeTab) {
            const hasData = allData && allData.length > 0;
            
            if (activeTab === 'grafici') {
                const analyticsSection = document.getElementById('analyticsSection');
                const noChartsMessage = document.getElementById('noChartsMessage');
                
                if (hasData) {
                    analyticsSection.style.display = 'block';
                    noChartsMessage.style.display = 'none';
                    // Ridimensiona grafico
                    setTimeout(() => {
                        if (currentChart && currentChart.resize) currentChart.resize();
                    }, 100);
                } else {
                    analyticsSection.style.display = 'none';
                    noChartsMessage.style.display = 'block';
                }
            }
            
            if (activeTab === 'tabelle') {
                const tableSection = document.getElementById('tableSection');
                const noTableMessage = document.getElementById('noTableMessage');
                
                if (hasData) {
                    tableSection.style.display = 'block';
                    noTableMessage.style.display = 'none';
                } else {
                    tableSection.style.display = 'none';
                    noTableMessage.style.display = 'block';
                }
            }
        }

        // Pagination
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                updateTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(allData.length / PAGE_SIZE);
            if (currentPage < totalPages - 1) {
                currentPage++;
                updateTable();
            }
        }

        // Utility functions
        function clearData() {
            allData = [];
            currentPage = 0;
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            
            document.getElementById('loadedDataInfo').style.display = 'none';
            document.getElementById('analyticsSection').style.display = 'none';
            document.getElementById('tableSection').style.display = 'none';
            
            showStatus('Tutti i dati sono stati cancellati', 'success');
        }

        function downloadCSV() {
            if (allData.length === 0) {
                alert('Nessun dato da esportare');
                return;
            }
            
            const headers = ['Gioco', 'Comparto', 'Anno', 'Mese', 'Canale', 'Codice', 'Concessionario', 'Ragione Sociale', 'Importo Raccolta', 'Importo Spesa'];
            
            let csv = headers.join(',') + '\n';
            
            allData.forEach(row => {
                const csvRow = [
                    `"${row.gameNameComplete || row.gameName}"`,
                    `"${row.comparto || ''}"`,
                    row.year,
                    `"${row.monthName}"`,
                    `"${row.channelName}"`,
                    row.codiceConcessione,
                    `"${row.concessionarioNome}"`,
                    `"${row.ragioneSociale}"`,
                    `"${row.importoRaccolta}"`,
                    `"${row.importoSpesa}"`
                ];
                csv += csvRow.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `gaming_analytics_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup chart event listeners
            document.getElementById('chartType').addEventListener('change', updateChart);
            document.getElementById('chartGroupBy').addEventListener('change', updateChart);
            
            console.log('Gaming Analytics Dashboard inizializzata');
            showStatus('Carica dei file Excel per iniziare l\'analisi', 'info');
        });
    </script>
</body>
</html>